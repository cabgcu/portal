<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>CAB Link Portal</title>
    <style>
        :root {
            --bg-dark: #000000;
            --glass-surface: rgba(0, 0, 0, 0.65); 
            --glass-border: rgba(255, 255, 255, 0.18);
            --text-main: #ffffff;
            --text-muted: #d1d1d6;
            --gradient-accent: linear-gradient(135deg, #0A84FF, #BF5AF2);
            --gradient-fire: linear-gradient(135deg, #FF9500, #FF3B30);
            --gradient-success: linear-gradient(135deg, #34C759, #30B0C7);
            --radius-card: 32px;
            --radius-btn: 20px; 
            --blur-bg: 4px; 
            --blur-card: 20px;
            --max-width-content: 500px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Segoe UI", Roboto, sans-serif; 
            color: var(--text-main); 
            background-color: var(--bg-dark); 
            min-height: 100vh; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* BLACK FADE OVERLAY */
        #loading-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: #000;
            opacity: 1;
            visibility: visible;
            transition: opacity 1.2s cubic-bezier(0.4, 0, 0.2, 1), visibility 1.2s;
            pointer-events: none;
        }

        /* BACKGROUND SYSTEM */
        #bg-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; overflow: hidden; background: #000; }
        .bg-slide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; opacity: 0; transition: opacity 2s ease-in-out; }
        .bg-slide.active { opacity: 0.6; }
        #bg-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(var(--blur-bg)); -webkit-backdrop-filter: blur(var(--blur-bg)); }

        .app-container { 
            position: relative; 
            width: 100%;
            max-width: var(--max-width-content); 
            margin: 0 auto; 
            padding: 40px 20px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .view { display: none; width: 100%; opacity: 0; transform: translateY(15px); transition: 0.4s ease; }
        .view.active { display: block; opacity: 1; transform: translateY(0); }

        .profile-header { text-align: center; margin-bottom: 36px; width: 100%; }
        
        .avatar-frame {
            width: 60px; 
            height: 60px;
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            overflow: visible;
        }

        .avatar { 
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: block;
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.6));
        }

        .profile-name { font-size: 1.6rem; font-weight: 700; margin: 0 0 8px; letter-spacing: -0.03em; }
        .profile-bio { color: var(--text-muted); font-size: 0.95rem; line-height: 1.5; margin: 0; max-width: 85%; margin: 0 auto; font-weight: 400; }
        
        .social-handle-tag {
            display: inline-block;
            margin-top: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #fff;
            background: rgba(255,255,255,0.1);
            padding: 6px 14px;
            border-radius: 100px;
            border: 1px solid var(--glass-border);
            text-decoration: none;
            transition: 0.3s;
        }
        .social-handle-tag:hover {
            background: var(--gradient-accent);
            border-color: transparent;
            transform: translateY(-2px);
        }

        /* LINKS */
        .links-container { width: 100%; display: flex; flex-direction: column; gap: 12px; }
        
        .link-item {
            width: 100%;
            padding: 16px 20px;
            min-height: 64px; 
            border-radius: var(--radius-btn);
            background: var(--glass-surface);
            backdrop-filter: blur(var(--blur-card));
            -webkit-backdrop-filter: blur(var(--blur-card));
            border: 1px solid var(--glass-border);
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-align: center;
            position: relative;
        }
        
        .link-item:hover {
            transform: translateY(-4px) scale(1.02);
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 10px 25px rgba(0,0,0,0.4), 0 0 15px rgba(10, 132, 255, 0.2);
        }
        
        .link-item:active {
            transform: translateY(0) scale(0.96);
            background: rgba(255, 255, 255, 0.15);
        }

        /* ADMIN UI */
        .frosted-card { 
            background: var(--glass-surface); 
            backdrop-filter: blur(var(--blur-card)); 
            -webkit-backdrop-filter: blur(var(--blur-card)); 
            border: 1px solid var(--glass-border); 
            padding: 24px; 
            border-radius: var(--radius-card);
            width: 100%;
        }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; color: var(--text-muted); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; }
        
        .control-item { 
            width: 100%; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); 
            color: #fff; padding: 16px; border-radius: 14px; font-family: inherit; font-size: 1rem; outline: none; transition: 0.3s;
        }
        
        .btn { padding: 16px 24px; border-radius: 14px; font-weight: 700; cursor: pointer; border: none; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; text-decoration: none; font-size: 1rem; width: 100%; }
        .btn-primary { background: var(--gradient-accent); color: white; }
        .btn-ghost { background: transparent; border: 1px solid rgba(255,255,255,0.1); color: var(--text-muted); margin-top: 10px; }
        
        footer { margin-top: 32px; padding: 20px 0; text-align: center; color: rgba(255, 255, 255, 0.3); font-size: 0.7rem; letter-spacing: 0.05em; width: 100%; }
        
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 350px; padding: 14px 20px; border-radius: 100px; background: var(--gradient-fire); font-weight: 700; z-index: 2000; display: none; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.3); font-size: 0.9rem; }

        .modal-content { position: relative; width: 95%; max-width: 380px; background: #000; border-radius: 28px; padding: 28px; border: 1px solid var(--glass-border); }

        .no-save-pass { -webkit-text-security: disc !important; }
        
        .loader { display: none; width: 16px; height: 16px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; animation: rotation 1s linear infinite; margin-left: 10px; }
        
        @keyframes rotation { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .list-manager { margin-bottom: 20px; display: flex; flex-direction: column; gap: 8px; max-height: 250px; overflow-y: auto; padding-right: 4px; }
        .list-row { display: flex; align-items: center; background: rgba(255,255,255,0.05); padding: 10px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); gap: 10px; }
        .list-name { flex: 1; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-remove { color: #FF3B30; cursor: pointer; font-size: 1.4rem; padding: 0 5px; }
        
        .move-controls { display: flex; flex-direction: column; gap: 2px; }
        .move-btn { cursor: pointer; font-size: 0.65rem; padding: 2px; opacity: 0.6; transition: 0.2s; user-select: none; }
        .move-btn:hover { opacity: 1; color: var(--gradient-accent); }
        .move-btn.disabled { opacity: 0.1; cursor: default; }
    </style>
</head>
<body>

<!-- INITIAL BLACK FADE OVERLAY -->
<div id="loading-overlay"></div>

<div id="bg-container"></div>
<div id="bg-overlay"></div>

<div class="app-container">
    
    <div id="portalView" class="view active">
        <div class="profile-header">
            <div class="avatar-frame" id="avatarFrame" style="display: none;">
                <img id="profileImg" src="" alt="Profile" class="avatar">
            </div>
            <h1 class="profile-name" id="portalName">CAB GCU</h1>
            <p class="profile-bio" id="portalBio"></p>
            <a href="#" id="portalHandle" class="social-handle-tag" style="display: none;"></a>
        </div>

        <div class="links-container" id="linksContainer"></div>
    </div>

    <div id="adminView" class="view">
        <div class="frosted-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="margin:0; font-size: 1.2rem;">Portal Settings</h2>
                <button class="btn btn-ghost" style="width: auto; margin:0; padding: 8px 16px; font-size: 0.8rem;" onclick="switchView('portal')">Close</button>
            </div>

            <div class="form-group">
                <label class="form-label">Profile Branding</label>
                <input type="text" id="setProfileName" class="control-item" placeholder="Display Name" style="margin-bottom: 10px;">
                <input type="text" id="setSocialHandle" class="control-item" placeholder="Handle (e.g. @cabgcu)" style="margin-bottom: 10px;">
                <textarea id="setProfileBio" class="control-item" placeholder="Short bio..." style="min-height: 70px; margin-bottom: 10px;"></textarea>
                <input type="text" id="setAvatarUrl" class="control-item" placeholder="Avatar Image URL">
            </div>

            <div class="form-group">
                <label class="form-label">Manage Links</label>
                <div id="link-list-manager" class="list-manager"></div>
                <div style="display: flex; flex-direction: column; gap: 8px; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 18px; border: 1px dashed rgba(255,255,255,0.2);">
                    <div style="display: grid; grid-template-columns: 60px 1fr; gap: 8px;">
                        <input type="text" id="newLinkIcon" class="control-item" placeholder="ðŸ”—" style="text-align: center;">
                        <input type="text" id="newLinkTitle" class="control-item" placeholder="Link Title">
                    </div>
                    <input type="text" id="newLinkUrl" class="control-item" placeholder="https://...">
                    <button class="btn btn-primary" style="margin-top:4px" onclick="addLinkUI()">Add New Link</button>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Admin Security</label>
                <input type="text" id="setNewPass" class="control-item no-save-pass" placeholder="Change password..." autocomplete="off">
            </div>

            <button class="btn btn-primary" id="saveBtn" onclick="saveAdminSettings()">
                <span>Save All Changes</span>
                <div class="loader" id="saveLoader" style="display: none; width: 16px; height: 16px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; animation: rotation 1s linear infinite; margin-left: 10px;"></div>
            </button>
        </div>
    </div>

    <footer>
        Â© <span id="year"></span> Canyon Activities Board <br>
        <span style="opacity: 0.5; font-size: 0.6rem; cursor: pointer; display: inline-block; padding-top: 15px;" onclick="showGate()">ADMIN ACCESS</span>
    </footer>
</div>

<div id="gateModal" class="modal" style="position: fixed; inset: 0; z-index: 1000; display: none; justify-content: center; align-items: center;">
    <div class="modal-bg" style="position: absolute; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px);" onclick="hideGate()"></div>
    <div class="modal-content">
        <h3 style="margin-top:0">Authorization</h3>
        <p style="color:var(--text-muted); font-size:0.85rem; margin-bottom:20px;">Enter the board password to edit the portal.</p>
        <input type="text" id="adminPass" class="control-item no-save-pass" placeholder="Password" style="margin-bottom:20px" onkeyup="if(event.key==='Enter') verifyAdmin()">
        <button class="btn btn-primary" id="gateBtn" onclick="verifyAdmin()">
            <span>Authorize</span>
            <div class="loader" id="gateLoader" style="display: none; width: 16px; height: 16px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; animation: rotation 1s linear infinite; margin-left: 10px;"></div>
        </button>
    </div>
</div>

<div id="toast">Update Successful</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbydG10e4oM8g0A8ZFgCeky-3r0pu9Cu0IGKA4b93zl6-ds4_VYiidbq13UPqQ2LgEQVWA/exec";
    
    let state = {
        config: {
            portalName: "CAB GCU",
            portalBio: "",
            socialHandle: "@cabgcu",
            avatarUrl: "",
            links: [],
            bgImages: []
        },
        bgIndex: 0,
        bgInterval: null
    };

    /** PORTAL LOGIC **/
    function init() {
        document.getElementById('year').textContent = new Date().getFullYear();
        syncData();
    }

    async function syncData() {
        try {
            const res = await fetch(SCRIPT_URL);
            const data = await res.json();
            if (data.config) {
                state.config.portalName = data.config.PortalName || "CAB GCU";
                state.config.portalBio = data.config.PortalBio || "";
                state.config.socialHandle = data.config.SocialHandle || "@cabgcu";
                state.config.avatarUrl = data.config.AvatarUrl || "";
                state.config.links = JSON.parse(data.config.LinksJson || "[]");
                state.config.bgImages = data.config.bgImages || [];
                
                renderPortal();
                initBackgroundRotation();
                stopLoading();
            }
        } catch (e) {
            console.error("Sync error:", e);
            stopLoading();
        }
    }

    function stopLoading() {
        const overlay = document.getElementById('loading-overlay');
        overlay.style.opacity = '0';
        setTimeout(() => {
            overlay.style.visibility = 'hidden';
        }, 1200);
    }

    function renderPortal() {
        document.getElementById('portalName').textContent = state.config.portalName;
        document.getElementById('portalBio').textContent = state.config.portalBio;
        
        const handleEl = document.getElementById('portalHandle');
        if (state.config.socialHandle) {
            handleEl.textContent = state.config.socialHandle;
            handleEl.style.display = 'inline-block';
            handleEl.href = `https://instagram.com/${state.config.socialHandle.replace('@', '')}`;
        } else {
            handleEl.style.display = 'none';
        }

        const avatarFrame = document.getElementById('avatarFrame');
        const profileImg = document.getElementById('profileImg');
        
        if (state.config.avatarUrl) {
            profileImg.src = state.config.avatarUrl;
            avatarFrame.style.display = 'flex';
        } else {
            avatarFrame.style.display = 'none';
        }

        const container = document.getElementById('linksContainer');
        if (state.config.links.length === 0) {
            container.innerHTML = `<p style="text-align:center; color:var(--text-muted); opacity:0.5; margin-top:20px;">Fetching resources...</p>`;
        } else {
            container.innerHTML = state.config.links.map(link => `
                <a href="${link.url}" target="_blank" class="link-item">
                    <span style="margin-right: 12px; font-size: 1.2rem;">${link.icon || 'ðŸ”—'}</span>
                    ${link.title}
                </a>
            `).join('');
        }

        document.getElementById('setProfileName').value = state.config.portalName;
        document.getElementById('setProfileBio').value = state.config.portalBio;
        document.getElementById('setSocialHandle').value = state.config.socialHandle;
        document.getElementById('setAvatarUrl').value = state.config.avatarUrl;
        renderAdminLinks();
    }

    function renderAdminLinks() {
        const mgr = document.getElementById('link-list-manager');
        const count = state.config.links.length;
        mgr.innerHTML = state.config.links.map((l, i) => `
            <div class="list-row">
                <div class="move-controls">
                    <span class="move-btn ${i === 0 ? 'disabled' : ''}" onclick="${i === 0 ? '' : `moveLinkUp(${i})`}">â–²</span>
                    <span class="move-btn ${i === count - 1 ? 'disabled' : ''}" onclick="${i === count - 1 ? '' : `moveLinkDown(${i})`}">â–¼</span>
                </div>
                <span class="list-name"><span>${l.icon || 'ðŸ”—'}</span> ${l.title}</span>
                <div class="list-remove" onclick="removeLink(${i})">&times;</div>
            </div>
        `).join('');
    }

    function moveLinkUp(index) {
        if (index > 0) {
            const link = state.config.links.splice(index, 1)[0];
            state.config.links.splice(index - 1, 0, link);
            renderAdminLinks();
        }
    }

    function moveLinkDown(index) {
        if (index < state.config.links.length - 1) {
            const link = state.config.links.splice(index, 1)[0];
            state.config.links.splice(index + 1, 0, link);
            renderAdminLinks();
        }
    }

    function addLinkUI() {
        const icon = document.getElementById('newLinkIcon').value.trim() || "ðŸ”—";
        const title = document.getElementById('newLinkTitle').value.trim();
        const url = document.getElementById('newLinkUrl').value.trim();
        
        if (!title || !url) return showToast("Enter title and URL", true);
        
        state.config.links.push({ title, url, icon });
        document.getElementById('newLinkIcon').value = "";
        document.getElementById('newLinkTitle').value = "";
        document.getElementById('newLinkUrl').value = "";
        renderAdminLinks();
    }

    function removeLink(index) {
        state.config.links.splice(index, 1);
        renderAdminLinks();
    }

    function switchView(v) {
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.getElementById(v + 'View').classList.add('active');
        window.scrollTo(0,0);
    }

    function initBackgroundRotation() {
        const container = document.getElementById('bg-container');
        if (!state.config.bgImages || state.config.bgImages.length === 0) return;

        container.innerHTML = state.config.bgImages.map((url, i) => `
            <div class="bg-slide ${i === 0 ? 'active' : ''}" style="background-image: url('${url}')"></div>
        `).join('');

        if (state.bgInterval) clearInterval(state.bgInterval);
        if (state.config.bgImages.length > 1) {
            state.bgInterval = setInterval(() => {
                const slides = document.querySelectorAll('.bg-slide');
                if (slides.length === 0) return;
                slides[state.bgIndex].classList.remove('active');
                state.bgIndex = (state.bgIndex + 1) % slides.length;
                slides[state.bgIndex].classList.add('active');
            }, 8000);
        }
    }

    async function verifyAdmin() {
        const pass = document.getElementById('adminPass').value;
        const btn = document.getElementById('gateBtn');
        const loader = document.getElementById('gateLoader');
        
        btn.disabled = true;
        loader.style.display = "inline-block";

        try {
            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "verifyPassword", password: pass })
            });
            const result = await res.json();
            
            if (result.success) {
                showToast("Access Granted", false);
                hideGate();
                switchView('admin');
            } else {
                showToast("Incorrect Password", true);
            }
        } catch (e) {
            showToast("Server Error", true);
        } finally {
            btn.disabled = false;
            loader.style.display = "none";
            document.getElementById('adminPass').value = "";
        }
    }

    async function saveAdminSettings() {
        const btn = document.getElementById('saveBtn');
        const loader = document.getElementById('saveLoader');
        
        const newConfig = {
            PortalName: document.getElementById('setProfileName').value,
            PortalBio: document.getElementById('setProfileBio').value,
            SocialHandle: document.getElementById('setSocialHandle').value,
            AvatarUrl: document.getElementById('setAvatarUrl').value,
            LinksJson: JSON.stringify(state.config.links)
        };
        
        btn.disabled = true;
        loader.style.display = "inline-block";

        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "updateConfig", config: newConfig })
            });
            
            const newPass = document.getElementById('setNewPass').value.trim();
            if (newPass) {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "changePassword", newPassword: newPass })
                });
            }

            showToast("Settings Saved!", false);
            await syncData();
            switchView('portal');
        } catch (e) {
            showToast("Save Failed", true);
        } finally {
            btn.disabled = false;
            loader.style.display = "none";
            document.getElementById('setNewPass').value = "";
        }
    }

    function showGate() { document.getElementById('gateModal').style.display = 'flex'; }
    function hideGate() { document.getElementById('gateModal').style.display = 'none'; }
    
    function showToast(msg, isError = false) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.style.background = isError ? 'var(--gradient-fire)' : 'var(--gradient-success)';
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
    }

    window.onload = init;
</script>
</body>
</html>
